<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 400px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .product-card {
            margin-bottom: 20px;
        }
        .product-card img {
            max-width: 100%;
            border-radius: 8px;
        }
        .product-details {
            margin-top: 10px;
        }
        .product-details h3 {
            margin: 10px 0;
            font-size: 1.5em;
        }
        .product-details p {
            font-size: 1.2em;
            color: #666;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        #click-to-pay-button {
            margin-top: 20px;
        }
        #card-details-form {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="product-card">
            <img src="https://via.placeholder.com/350x150" alt="Product Image">
            <div class="product-details">
                <h3>Product Name</h3>
                <p>$100.00</p>
            </div>
        </div>
        <div id="card-details-form">
            <div class="form-group">
                <input type="text" id="card-number" placeholder="Card Number" />
            </div>
            <div class="form-group">
                <input type="text" id="expiration-month" placeholder="Expiration Month" />
            </div>
            <div class="form-group">
                <input type="text" id="expiration-year" placeholder="Expiration Year" />
            </div>
            <div class="form-group">
                <input type="text" id="security-code" placeholder="Security Code" />
            </div>
        </div>
        <div class="form-group">
            <button id="click-to-pay">Click to Pay</button>
        </div>
    </div>
    
    <!-- Mastercard Click to Pay library -->
    <script src="https://sandbox.src.mastercard.com/srci/integration/2/lib.js?srcDpaId=01b2280e-6d56-4226-a5c7-a84dce0cd8f3&locale=en_US"></script>

    <script>
        var isFirstTimeUser = true; // This should be dynamically determined based on your logic
        
        // Listen for messages from the Mastercard iframe
        window.addEventListener("message", function(event) {
            if (event.origin !== "https://sandbox.src.mastercard.com") {
                return;
            }

            switch(event.data.message) {
                case "READY":
                    console.log("Mastercard iframe is ready");
                    // Handle any additional actions when the iframe is ready
                    break;
                default:
                    console.log("Unknown message received:", event.data.message);
            }
        });

        // Initialize Mastercard Click to Pay
        var mcCheckoutService = new MastercardCheckoutServices();

        async function initializeMastercardCheckoutServices() {
            try {
                var result = await mcCheckoutService.init({
                    "srcDpaId": "01b2280e-6d56-4226-a5c7-a84dce0cd8f3",
                    "checkoutExperience":"WITHIN_CHECKOUT",
                    "dpaData": {
                        "dpaName": "Registered DPA Name"
                    },
                    "dpaTransactionOptions": {
                        "consumerEmailAddressRequested": true,
                        "consumerPhoneNumberRequested": true,
                        "dpaBillingPreference": "FULL",
                        "dpaLocale": "en_US",
                        "paymentOptions": [
                            {
                                "dynamicDataType": "CARD_APPLICATION_CRYPTOGRAM_SHORT_FORM"
                            }
                        ],
                        "transactionAmount": {
                            "transactionAmount": 100,
                            "transactionCurrencyCode": "USD"
                        }
                    },
                    "cardBrands": [
                        "mastercard",
                    ],
                });
                
                console.log("Initialization Result:", result);

                if (isFirstTimeUser) {
                    // Show card details form for first-time users
                    document.getElementById("card-details-form").style.display = "block";
                }

                // Event listener for Click to Pay button
                document.getElementById("click-to-pay").addEventListener("click", async function() {
                    let encryptedCard;

                    if (isFirstTimeUser) {
                        // Encrypt card details dynamically
                        encryptedCard = await mcCheckoutService.encryptCard({
                            "primaryAccountNumber": document.getElementById("card-number").value,
                            "panExpirationMonth": document.getElementById("expiration-month").value,
                            "panExpirationYear": document.getElementById("expiration-year").value,
                            "cardSecurityCode": document.getElementById("security-code").value,
                            "cardholderFirstName": "Jane",
                            "cardholderLastName": "Doe",
                            "billingAddress": {
                                "name": "Jane Doe",
                                "line1": "Street 1",
                                "line2": "string",
                                "line3": "string",
                                "city": "New York",
                                "state": "NY",
                                "zip": "10009",
                                "countryCode": "US"
                            }
                        });
                    } else {
                        // Use pre-stored encrypted card data for returning users
                        encryptedCard = { encryptedCard: "storedEncryptedCardData" }; // Replace with actual stored data
                    }
                    
                    console.log("Encrypted Card:", encryptedCard);

                    var checkoutResult = await mcCheckoutService.checkoutWithNewCard({
                        "windowRef": window.open("", "popupWindow", "width=480,height=600"), // Open in popup
                        "encryptedCard": encryptedCard.encryptedCard,
                        "cardBrand": "mastercard",
                        "rememberMe": "true",
                        "consumer": {
                            "emailAddress": "test.user@test.com",
                            "mobileNumber": {
                                "phoneNumber": "3470000000",
                                "countryCode": "1"
                            },
                            "firstName": "Test",
                            "lastName": "User"  
                        },
                        "dpaTransactionOptions": {
                            "authenticationPreferences": {
                                "payloadRequested": "AUTHENTICATED"
                            },
                        }
                    });
                    
                    console.log("Checkout Result:", checkoutResult);
                    alert("Checkout Result: " + JSON.stringify(checkoutResult));
                });

            } catch (error) {
                console.error("Error during Mastercard Checkout initialization:", error);
            }
        }

        initializeMastercardCheckoutServices();
    </script>
</body>
</html>
